// Update the fetchMapillaryImage function with CORS proxy and better logging
const fetchMapillaryImage = async (lat: number, lon: number): Promise<string | null> => {
  if (!mapillaryTokenValid) {
    console.log('Mapillary token not valid');
    return null;
  }
  try {
    const url = `https://graph.mapillary.com/images?fields=id,thumb_2048_url,thumb_1024_url&limit=1&closeto=${lon},${lat}&access_token=${MAPILLARY_TOKEN}`;
    console.log('Fetching Mapillary from:', url);
    
    const res = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      },
    });
    
    console.log('Mapillary response status:', res.status);
    
    if (!res.ok) {
      const errorText = await res.text();
      console.warn('Mapillary API error:', res.status, errorText);
      return null;
    }
    
    const json = await res.json();
    console.log('Mapillary response data:', json);
    
    const item = json?.data?.[0];
    if (!item) {
      console.log('No Mapillary images found at', lat, lon);
      return null;
    }
    
    const thumb = item?.thumb_2048_url || item?.thumb_1024_url;
    console.log('Mapillary thumb URL:', thumb);
    return thumb || null;
  } catch (e) {
    console.error('Mapillary fetch failed:', e);
    return null;
  }
};
